import os
import random
from django.core.files.base import ContentFile
from django.core.management.base import BaseCommand
from product.models import Category
from slugify import slugify

IMAGE_DIR = "/home/ahmed/Desktop/project/src/media/base_images"

CATEGORIES = {
    "هدايا حسب المناسبة": [
        ("عيد ميلاد", "احتفل مع من تحب بأجمل الهدايا المختارة بعناية لتناسب جميع الأعمار في يومهم المميز."),
        ("رمضان", "زينة رمضانية وهدايا تعكس روح الشهر الفضيل وتنشر الأجواء الروحانية."),
        ("عيد الأم", "عبّر عن امتنانك وحبك لأمك مع هدايا فاخرة تليق بمكانتها."),
        ("اسلاميات", "هدايا دينية تعكس القيم الاسلامية وتناسب المناسبات الدينية."),
        ("العيد", "هدايا بهجة العيد ولمسات أنيقة تدخل السرور على قلوب أحبابك."),
    ],
    "هدايا حسب الشخص": [
        ("للرجال", "اختيارات عملية وفخمة تناسب الرجل العصري وتعكس ذوقك في اختيار الهدايا."),
        ("للنساء", "منتجات راقية وعصرية تضيف لمسة أنثوية رقيقة وتناسب جميع الأذواق."),
        ("للأطفال", "هدايا ممتعة وتعليمية تجمع بين المرح والفائدة للأطفال."),
    ],
    "هدايا حسب النوع": [
        ("شوكولاتة", "أفخم أنواع الشوكولاتة المغلفة بشكل أنيق، مثالية للإهداء."),
        ("ورد", "باقات ورد طبيعية ومنسّقة بعناية تضيف لمسة رومانسية وعطرية."),
        ("منتجات مطبوعة", "أكواب بتصاميم مخصصة تعبر عن الشخصية والمناسبة."),
    ],
    "أجهزة منزلية": [
        ("أدوات مطبخ", "منتجات تسهّل الطبخ وتحسّن تجربة المطبخ باحتراف."),
        ("أجهزة كهربائية", "معدات كهربائية ضرورية لكل منزل عصري بجودة وأداء ممتاز."),
    ],
    "منتجات شخصية": [
        ("عطور", "تشكيلة من العطور المميزة بروائح جذابة وثبات يدوم."),
        ("ساعات", "ساعات أنيقة تعكس الذوق وتناسب كل المناسبات."),
        ("نظارات شمس", "نظارات تحمي العين وتضيف لمسة من الأناقة في آنٍ واحد."),
    ],
    "مستلزمات مكتبية": [
        ("دفاتر وأجندات", "أدوات تنظيم يومية بتصاميم أنيقة لتحفيز الإنتاجية."),
        ("أقلام وهدايا مكتبية", "أدوات مكتبية فاخرة مثالية للمكتب أو كهدايا عملية."),
    ],
    "ديكور منزلي": [
        ("لوحات فنية", "قطع فنية تضيف لمسة جمالية لأي مساحة داخل المنزل."),
        ("شموع معطرة", "شموع بروائح طبيعية تبعث على الراحة والسكينة."),
        ("مزهريات", "تصاميم أنيقة لإبراز جمال الزهور وإضفاء لمسة ناعمة."),
        ("ساعات حائط", "تصاميم مودرن وكلاسيكية تنسجم مع مختلف الديكورات."),
        ("وسائد زخرفية", "وسائد بألوان ونقوش جذابة تزيد من أناقة الأثاث."),
        ("مصابيح وطاولات جانبية", "إضاءة دافئة وتصاميم عصرية لزوايا المنزل."),
        ("حافظات تنظيم", "صناديق وسلال أنيقة لترتيب المساحات بشكل ذكي."),
        ("مرايا ديكورية", "مرايا تضيف إحساساً بالاتساع وتزيد من الإضاءة."),
        ("ستائر وإكسسواراتها", "أقمشة فاخرة بألوان متناسقة تعكس ذوقك الرفيع."),
        ("نباتات صناعية", "لمسة خضراء لا تحتاج عناية، تضفي حيوية على المكان."),
    ],
    "ألعاب وترفيه": [
        ("ألعاب لوحية", "ألعاب جماعية تضيف المرح والتسلية للأصدقاء والعائلة."),
        ("ألعاب تعليمية", "ألعاب تنمّي مهارات التفكير والإبداع لدى الأطفال."),
        ("ألعاب إلكترونية", "أجهزة وألعاب رقمية تدمج بين التكنولوجيا والمرح."),
        ("ألعاب تركيب", "ألعاب تفاعلية تعتمد على التركيب والبناء لتعزيز الذكاء البصري."),
        ("ألعاب أطفال صغار", "ألعاب آمنة ومناسبة للأطفال في أعمار مبكرة."),
        ("ألعاب حركية", "منتجات تشجع على النشاط البدني والتفاعل الحركي داخل المنزل أو خارجه."),
        ("ألعاب ذكية", "ألعاب حديثة تعتمد على التفكير المنطقي والذكاء الاصطناعي."),
    ],
    "إلكترونيات": [
        ("سماعات", "جودة صوت عالية بتصاميم مريحة وأداء مميز."),
        ("باور بانك", "شحن متنقل موثوق لحماية أجهزتك في كل مكان."),
        ("كابلات وشواحن", "ملحقات شحن أصلية وسريعة لجميع أنواع الأجهزة."),
        ("ساعات ذكية", "تابع نشاطك الصحي والبقاء على اتصال بأناقة."),
        ("أجهزة تتبع", "حلول ذكية لتعقّب الأشياء الثمينة والمركبات."),
        ("مكبرات صوت بلوتوث", "تجربة صوتية محمولة وغامرة في أي مكان."),
        ("حوامل ومثبتات هواتف", "ثبات وسهولة استخدام أثناء القيادة أو التصوير."),
        ("لوحات مفاتيح وفأرات", "إكسسوارات مكتبية لتجربة استخدام مريحة ومنتجة."),
        ("كروت ذاكرة وفلاشات", "تخزين بيانات آمن وسريع لجميع احتياجاتك."),
        ("إضاءات LED ذكية", "تحكّم بالإضاءة بأناقة باستخدام تطبيقات الهاتف."),
    ]
}


class Command(BaseCommand):
    help = "Seed categories and subcategories with random images"

    def handle(self, *args, **kwargs):
        def unique_slugify(base_slug):
            slug = base_slug
            counter = 1
            while Category.objects.filter(slug=slug).exists():
                slug = f"{base_slug}-{counter}"
                counter += 1
            return slug

        def get_random_image_file():
            images = [
                f for f in os.listdir(IMAGE_DIR)
                if f.lower().endswith(('.jpg', '.jpeg', '.png'))
            ]
            if not images:
                return None
            return os.path.join(IMAGE_DIR, random.choice(images))

        def add_random_image(category):
            image_path = get_random_image_file()
            if image_path and not category.image:
                with open(image_path, "rb") as f:
                    image_data = f.read()
                    file_name = os.path.basename(image_path)
                    django_file = ContentFile(image_data, name=file_name)
                    category.image.save(file_name, django_file, save=True)

        for parent_name, subcats in CATEGORIES.items():
            parent_cat, _ = Category.objects.get_or_create(
                name=parent_name,
                parent=None,
                defaults={
                    "description": f"قسم {parent_name} يحتوي على مجموعة متنوعة من المنتجات عالية الجودة.",
                    "slug": unique_slugify(slugify(parent_name)),
                },
            )
            add_random_image(parent_cat)

            for name, description in subcats:
                cat, created = Category.objects.get_or_create(
                    name=name,
                    parent=parent_cat,
                    defaults={
                        "description": description,
                        "slug": unique_slugify(slugify(name)),
                    },
                )
                add_random_image(cat)

        self.stdout.write(self.style.SUCCESS("✅ Categories (with random images) seeded successfully."))
